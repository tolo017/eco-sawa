<!doctype html>
<html>
<head>
<meta charset="utf-8" /><meta name="viewport" content="width=device-width,initial-scale=1" />
<title>EcoSawa — Rescuer Dashboard</title>
<link rel="stylesheet" href="styles.css" />
<link rel="manifest" href="manifest.json" />
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script> const API_BASE='http://localhost:4000/api'; </script>
<script src="auth.js"></script>
</head>
<body>
<div class="container">
  <div class="app-header">
    <div class="brand">
      <div class="logo">ES</div>
      <div>
        <div style="font-weight:800">Rescuer Dashboard</div>
        <div class="small-muted">Accept pickups & schedule collections</div>
      </div>
    </div>
    <div class="app-actions">
      <div id="profileArea" class="profile-bubble small-muted"></div>
      <button class="btn ghost" id="backHome">Home</button>
    </div>
  </div>

  <div class="grid">
    <div>
      <div class="card map-card">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div class="section-title">Map — Nairobi & Kiambu</div>
          <div class="small">Click map to set your location</div>
        </div>
        <div id="map"></div>
      </div>

      <div class="card" style="margin-top:12px">
        <div class="section-title">Available Pickups</div>
        <div id="availableList">Loading pickups…</div>
      </div>
    </div>

    <div>
      <div class="card">
        <div class="section-title">My Pickups</div>
        <div id="myPickups">No claimed pickups</div>
      </div>

      <div class="card" style="margin-top:12px">
        <div class="section-title">Route & Schedule</div>
        <div class="small">Optimize route for your claimed pickups or propose pickup times.</div>
        <div style="margin-top:8px">
          <button class="btn" id="optimizeBtn">Optimize Route</button>
          <div id="routeResult" class="small" style="margin-top:8px"></div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
if ('serviceWorker' in navigator) navigator.serviceWorker.register('/sw.js').catch(()=>{});
const el = id => document.getElementById(id);

function getToken(){ return localStorage.getItem('eco_token'); }
function renderProfile(){
  const t = getToken();
  el('profileArea').innerText = t ? 'Signed in' : 'Not signed in';
}
renderProfile();

const nairobi = [-1.28333, 36.81667];
const map = L.map('map').setView(nairobi, 11);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
const bounds = L.latLngBounds([ -1.6, 36.5 ], [ -0.9, 37.4 ]);
map.setMaxBounds(bounds);

map.on('click', function(e){
  const lat = e.latlng.lat, lon = e.latlng.lng;
  let token = getToken();
  if(!token){ alert('Please login (auth required)'); return; }
  // set rescuer location on backend via push subscribe (or local store by calling /api/rescuers if implemented)
  alert('Location set locally for demo. You can now accept pickups near this point.');
});

let markers = L.layerGroup().addTo(map);

async function loadAvailable(){
  const r = await fetch(API_BASE + '/listings').then(r=>r.json()).catch(()=>({ listings: [] }));
  const c = el('availableList'); c.innerHTML = '';
  markers.clearLayers();
  if(!r.listings.length){ c.innerHTML = '<div class="small">No pickups available</div>'; return; }
  r.listings.forEach(l=>{
    const color = l.urgencyColor === 'red' ? '#ff2b2b' : (l.urgencyColor === 'orange' ? '#ff9f1c' : '#28a745');
    const div = document.createElement('div'); div.className='listing';
    div.innerHTML = `<div style="display:flex;gap:8px;align-items:center"><div><div class="pill ${l.urgencyColor}">${l.perishabilityTag}</div></div><div><div style="font-weight:700">${l.foodType} — ${l.quantityKg}kg</div><div class="small">${l.address || ''} ${l.timeWindow ? ' | ' + l.timeWindow : ''}</div></div></div>`;
    const right = document.createElement('div');
    const btn = document.createElement('button'); btn.className='btn'; btn.innerText='Accept & Schedule';
    btn.onclick = ()=> acceptAndSchedule(l);
    right.appendChild(btn);
    div.appendChild(right);
    c.appendChild(div);

    const marker = L.circleMarker([l.lat, l.lon], { color, radius:8, fillColor: color, fillOpacity:0.8 }).addTo(markers);
    marker.bindPopup(`<b>${l.foodType}</b><br/>${l.quantityKg}kg — ${l.perishabilityTag}<br/><div style="margin-top:6px"><button onclick="acceptFromMap('${l.id}')">Accept & Schedule</button></div>`);
  });
}
window.acceptFromMap = async function(id){
  const t = getToken(); if(!t){ alert('Please login'); return; }
  const token = t;
  const claim = await fetch(API_BASE + '/listings/' + id + '/claim', { method:'POST', headers:{'Content-Type':'application/json','Authorization':'Bearer ' + token}, body: JSON.stringify({}) }).then(r=>r.json());
  if(claim.ok){ alert('Claimed'); loadMyPickups(); loadAvailable(); } else alert('Error:' + JSON.stringify(claim));
};

async function acceptAndSchedule(listing){
  const t = getToken(); if(!t){ alert('Please login'); return; }
  const token = t;
  const claim = await fetch(API_BASE + '/listings/' + listing.id + '/claim', { method:'POST', headers:{'Content-Type':'application/json','Authorization':'Bearer ' + token}, body: JSON.stringify({}) }).then(r=>r.json());
  if(!claim.ok){ alert('Could not claim'); return; }
  const sched = prompt('Propose pickup time (YYYY-MM-DDTHH:MM), leave blank for ASAP:');
  if(sched){
    const key = 'eco_schedules';
    const schedules = JSON.parse(localStorage.getItem(key) || '{}');
    schedules[listing.id] = sched;
    localStorage.setItem(key, JSON.stringify(schedules));
  }
  loadMyPickups(); loadAvailable();
}

async function loadMyPickups(){
  const token = getToken(); if(!token){ el('myPickups').innerHTML = '<div class="small">Login to see your pickups</div>'; return; }
  const all = await fetch(API_BASE + '/listings/all').then(r=>r.json()).then(d=>d.listings||[]);
  const p = null;
  const mine = all.filter(l => l.claimedBy);
  const c = el('myPickups'); c.innerHTML='';
  if(!mine.length){ c.innerHTML = '<div class="small">No claimed pickups</div>'; return; }
  const schedules = JSON.parse(localStorage.getItem('eco_schedules') || '{}');
  mine.forEach(m=>{
    const d = document.createElement('div'); d.className='listing';
    d.innerHTML = `<div><div style="font-weight:700">${m.foodType}</div><div class="small">${m.address || ''} ${m.timeWindow ? ' | ' + m.timeWindow : ''}</div><div class="small">Scheduled: ${schedules[m.id] || 'ASAP'}</div></div>`;
    const right = document.createElement('div');
    const btnConfirm = document.createElement('button'); btnConfirm.className='btn'; btnConfirm.innerText='Confirm (QR)';
    btnConfirm.onclick = ()=> confirmWithQR(m);
    right.appendChild(btnConfirm);
    d.appendChild(right);
    c.appendChild(d);
  });
}

async function confirmWithQR(listing){
  const token = getToken(); if(!token){ alert('Please login'); return; }
  const tk = prompt('Paste QR token from donor (or token shown on donor page)');
  if(!tk) return;
  const r = await fetch(API_BASE + '/listings/' + listing.id + '/confirm-qr', {
    method:'POST', headers:{'Content-Type':'application/json','Authorization':'Bearer ' + token},
    body: JSON.stringify({ token: tk })
  }).then(r=>r.json());
  if(r.ok){ alert('Pickup confirmed'); loadMyPickups(); loadAvailable(); }
  else alert('Error: ' + (r.error || JSON.stringify(r)));
}

el('backHome').addEventListener('click', ()=> location.href='index.html');

el('optimizeBtn').addEventListener('click', async ()=>{
  const token = getToken(); if(!token){ alert('Login to optimize'); return; }
  const all = await fetch(API_BASE + '/listings/all').then(r=>r.json()).then(d=>d.listings||[]);
  const mine = all.filter(l => l.claimedBy);
  if(!mine.length){ el('routeResult').innerText = 'No pickups to optimize'; return; }
  const listingIds = mine.map(m => m.id);
  const resp = await fetch(API_BASE + '/route/optimize', {
    method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ rescuerLocation: { lat: nairobi[0], lon: nairobi[1] }, listingIds })
  }).then(r=>r.json());
  const ids = resp.route.map(x => x.id).join(' → ');
  el('routeResult').innerText = 'Optimized: ' + ids + ` (≈ ${resp.totalKm ? resp.totalKm + ' km' : ''})`;
});

loadAvailable();
loadMyPickups();
</script>
</body>
</html>
